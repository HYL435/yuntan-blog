server:
  port: 9000  # 网关端口，避免与后端服务冲突
spring:
  application:
    name: blog-gateway  # 网关唯一服务名，确保和其他服务（如blog-user）不重复
  profiles:
    active: dev  # 指定环境为dev，加载对应环境的配置
  config:
    import:
      # 优化：按优先级排序公共配置，统一添加optional避免配置不存在时启动失败
      - optional:nacos:shared-log.yaml?group=DEFAULT_GROUP&refresh=true
      - optional:nacos:shared-jdbc.yaml?group=DEFAULT_GROUP&refresh=true
      - optional:nacos:shared-mybatis-plus.yaml?group=DEFAULT_GROUP&refresh=true
      - optional:nacos:shared-redis.yaml?group=DEFAULT_GROUP&refresh=true
      - optional:nacos:shared-oss.yaml?group=DEFAULT_GROUP&refresh=true
      - optional:nacos:shared-swagger.yaml?group=DEFAULT_GROUP&refresh=true
      # 关键：添加网关自身的配置文件（如果有），避免和common配置混淆

  cloud:
    nacos:
      # 全局Nacos服务地址，统一复用，避免重复配置
      server-addr: 127.0.0.1:8848
      username: nacos
      password: 766498
      # Nacos配置中心配置
      config:
        server-addr: ${spring.cloud.nacos.server-addr}
        file-extension: yaml
        namespace: public  # 确认Nacos的namespace是public（默认是public，不要填错）
        group: DEFAULT_GROUP
        username: ${spring.cloud.nacos.username}
        password: ${spring.cloud.nacos.password}
        # 优化：指定配置文件的dataId前缀，和服务名一致
        prefix: ${spring.application.name}
      # Nacos注册中心配置
      discovery:
        server-addr: ${spring.cloud.nacos.server-addr}
        namespace: ${spring.cloud.nacos.config.namespace}
        group: ${spring.cloud.nacos.config.group}
        username: ${spring.cloud.nacos.username}
        password: ${spring.cloud.nacos.password}
        metadata:
          version: v1.0
          # 补充：添加元数据标识服务类型，便于排查
          service-type: gateway
    # 网关核心配置（补充：网关必须配置路由规则，否则无法转发请求）
    gateway:
      discovery:
        locator:
          enabled: true  # 开启服务发现，支持通过服务名转发
          lower-case-service-id: true  # 服务名小写
      routes:
        # 示例：用户服务路由规则
        - id: blog-user-service-route
          uri: lb://blog-user-service  # 转发到Nacos中的blog-user-service服务
          predicates:
            - Path=/front/users/**  # 匹配用户服务的请求路径
          filters:
            - StripPrefix=0  # 不截取路径前缀（根据实际需求调整）
  # 解决Bean覆盖问题（仅在必要时开启，生产环境建议排查Bean重复定义）
  main:
    allow-bean-definition-overriding: true

# JWT认证配置（适配网关的AuthGlobalFilter）
yuntan:
  jwt:
    location: classpath:yuntan.jks  # JKS文件路径，确保文件在resources根目录
    alias: yuntan                   # JKS密钥别名，和生成时一致
    password: 766498                # JKS密钥库密码
    token-ttl: 10800000             # token有效期3小时（10800秒）
    refresh-ttl: 604800000          # 刷新令牌有效期7天
    issuer: yuntan-blog             # JWT签发者
    subject: blog-gateway           # 调整为网关的主题，和服务名一致
    header: Authorization           # 请求头中的token字段名
    prefix: Bearer                  # token前缀，需和前端一致
  auth:
    # 优化：路径匹配支持通配符，更灵活
    exclude-paths:
      - /front/users/login/**
      - /front/users/register/**
      - /docs/**
      - /swagger-ui/**
      - /v3/api-docs/**
      - /actuator/**
      # 补充：添加网关健康检查路径
      - /health/**